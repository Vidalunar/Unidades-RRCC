<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Unidad en los RRCC ‚Äî Puzzle visual</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Fuente -->
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

<style>
  :root{
    --c-dinastica:#7EC8E3;
    --c-territorial:#E0B437;
    --c-religiosa:#7FD6C2;
    --c-linguistica:#E5873A;
    --c-politica:#8C6AD2;
    --c-center:#9AA6B2;

    --l-dinastica:#E8F6FB;
    --l-territorial:#FBF3D9;
    --l-religiosa:#E9FBF6;
    --l-linguistica:#FCEFE6;
    --l-politica:#EFEAFB;
  }
  body{font-family:'Patrick Hand', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
  html,body{height:100%}
  .card{user-select:none; cursor:grab}
  .card:active{cursor:grabbing}
  .dropzone.drag-over{outline:3px dashed rgba(0,0,0,.25);}
  .slot{
    min-height:3.25rem; border:2px dashed #CBD5E1; border-radius:.8rem;
    background:white; display:flex; align-items:center; padding:.5rem .6rem;
  }
  .slot.filled{border-style:solid; border-color:#A3E635}
  .hint-bubble{
    position:absolute; z-index:50; background:#111827; color:white;
    font-size:.95rem; padding:.5rem .65rem; border-radius:.5rem;
    max-width:18rem; box-shadow:0 10px 30px rgba(0,0,0,.25);
  }

  /* Baraja com√∫n (sidebar o dock) */
  #deck{display:flex; gap:.75rem; flex-wrap:wrap; overflow:auto; scroll-snap-type:x mandatory;}
  #deck .card{scroll-snap-align:start}

  /* Layout: tablero + baraja visible */
  .layout-grid{display:grid; gap:1rem; grid-template-columns: 1fr;}
  .deck-dock{position:sticky; bottom:.5rem; z-index:30; background:white; border-radius:1rem; border:1px solid #e5e7eb; padding:.75rem; box-shadow:0 8px 28px rgba(0,0,0,.15);}
  @media (min-width:768px){
    .layout-grid{grid-template-columns: minmax(0,1fr) 320px; align-items:start;}
    .deck-sidebar{position:sticky; top:5.5rem; max-height:calc(100vh - 6.5rem); overflow:auto; border:1px solid #e5e7eb; border-radius:1rem; background:white; box-shadow:0 8px 28px rgba(0,0,0,.08); padding:.75rem;}
  }

  /* Logo circular */
  .brand{
    width:42px;height:42px;border-radius:9999px;overflow:hidden;
    background:#0f172a;
    display:grid;place-items:center;
  }
  .brand img{width:100%;height:100%;object-fit:cover}
  /* Marca de agua */
  .watermark{
    position:fixed; right:1.2rem; bottom:1.2rem; z-index:0;
    opacity:.06; width:140px; height:140px; pointer-events:none;
    filter:grayscale(10%);
  }
</style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Marca de agua -->
  <img class="watermark rounded-full" src="pr-sello.png" alt="Sello PR Educaci√≥n">

  <!-- Barra -->
  <header class="w-full border-b bg-white/90 sticky top-0 z-40 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-3 flex flex-wrap items-center gap-3 justify-between">
      <div class="flex items-center gap-3">
        <!-- Logo circular con tu imagen -->
        <div class="brand border border-white/60 shadow-sm">
          <img src="pr-sello.png" alt="PR Educaci√≥n">
        </div>
        <div class="relative z-10">
          <h1 class="text-2xl leading-6">Unidad en los RRCC ‚Äî Puzzle visual</h1>
          <p class="text-sm text-slate-500 -mt-1">Baraja siempre visible (sidebar/dock). iPad listo.</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="basicBtn" class="px-4 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm">Nivel B√°sico</button>
        <button id="proBtn" class="px-4 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm">Nivel Pro</button>
        <div class="mx-2 h-6 w-px bg-slate-300 hidden sm:block"></div>
        <button id="hintBtn" class="px-3 py-2 rounded-xl bg-amber-200 hover:bg-amber-300 text-amber-950 text-sm">Pide un comod√≠n</button>
        <button id="resetBtn" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-black text-white text-sm">Reiniciar</button>
        <div class="mx-2 h-6 w-px bg-slate-300 hidden sm:block"></div>
        <div class="text-right">
          <div class="text-xs text-slate-500">Cron√≥metro</div>
          <div id="timer" class="font-semibold text-lg tabular-nums">00:00</div>
          <div id="best" class="text-[11px] text-slate-500"></div>
        </div>
      </div>
    </div>
  </header>

  <!-- Cabecera central -->
  <div class="grid place-items-center mt-4">
    <div class="rounded-2xl px-4 py-3 text-center text-white shadow-inner" style="background:var(--c-center)">
      <div class="text-xs">Nodo central</div>
      <div class="text-lg font-semibold">UNIDAD EN LOS RRCC</div>
    </div>
  </div>

  <!-- Layout: tablero + baraja visible -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="layout" class="layout-grid">
      <!-- Tableros -->
      <section id="boardContainer" class="relative z-10">
        <!-- ===== B√ÅSICO (AHORA con huecos gu√≠a) ===== -->
        <div id="basicBoard" class="hidden bg-white rounded-2xl shadow-sm border p-4">
          <div id="basicCols" class="grid md:grid-cols-5 gap-4"><!-- columnas JS --></div>
          <p class="mt-3 text-sm text-slate-500 text-center">Coloca aqu√≠ los ep√≠grafes e <b>√≠tems coloreados</b>. Los huecos sirven de gu√≠a.</p>
        </div>

        <!-- ===== PRO (slots visibles) ===== -->
        <div id="proBoard" class="hidden bg-white rounded-2xl shadow-sm border p-4">
          <div id="proCols" class="grid md:grid-cols-5 gap-4"><!-- columnas JS --></div>
          <p class="mt-3 text-sm text-slate-500 text-center">En cada unidad hay <b>huecos</b> del color de su unidad.</p>
        </div>
      </section>

      <!-- Sidebar / Dock con baraja -->
      <aside id="deckSection" class="deck-sidebar md:block">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg">Tarjetas</h2>
          <span id="leftCount" class="text-sm text-slate-500"></span>
        </div>
        <div id="deck" class="bg-white rounded-xl border p-2 min-h-[9rem]"></div>
      </aside>
    </div>
  </main>

  <!-- Instrucciones (al final) -->
  <section class="max-w-7xl mx-auto px-4 pb-8">
    <details class="bg-white rounded-2xl p-4 shadow-sm border">
      <summary class="cursor-pointer text-base">C√≥mo ejecutar y jugar</summary>
      <ol class="list-decimal pl-6 mt-2 text-[15px] leading-6">
        <li>Guarda este archivo como <b>rrcc-puzzle.html</b> y <b>√°brelo con doble clic</b>.</li>
        <li>Coloca la imagen del sello en la misma carpeta con el nombre <b>pr-sello.png</b>.</li>
        <li>Elige <b>Nivel B√°sico</b> (tarjetas ya coloreadas y <b>huecos gu√≠a</b>) o <b>Nivel Pro</b> (tarjetas sin color hasta acertar y huecos obligatorios).</li>
        <li>Arrastra cada tarjeta a su unidad. Si aciertas (Pro) se ti√±e con un <b>tono claro</b> del color de la unidad.</li>
        <li><b>Pide un comod√≠n</b>: pulsa y luego toca una tarjeta para ver su explicaci√≥n.</li>
        <li><b>Reiniciar</b> baraja el modo activo. Tu <b>mejor marca</b> se guarda en este navegador.</li>
      </ol>
    </details>
  </section>

  <!-- Modal victoria -->
  <dialog id="winDlg" class="rounded-2xl p-0 backdrop:bg-black/40">
    <div class="p-5 bg-white rounded-2xl w-[min(92vw,28rem)]">
      <h3 class="text-xl mb-2">¬°Esquema completado! üéâ</h3>
      <p id="resultTxt" class="text-slate-700"></p>
      <div class="flex justify-end gap-2 mt-4">
        <button id="againBtn" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-black text-white">Volver a jugar</button>
        <button id="closeBtn" class="px-4 py-2 rounded-xl border">Cerrar</button>
      </div>
    </div>
  </dialog>

<script>
/* ===== Colores ===== */
const COLORS = {
  'Din√°stica':'var(--c-dinastica)',
  'Territorial':'var(--c-territorial)',
  'Religiosa':'var(--c-religiosa)',
  'Ling√º√≠stica':'var(--c-linguistica)',
  'Pol√≠tica':'var(--c-politica)'
};
const LIGHTS = {
  'Din√°stica':'var(--l-dinastica)',
  'Territorial':'var(--l-territorial)',
  'Religiosa':'var(--l-religiosa)',
  'Ling√º√≠stica':'var(--l-linguistica)',
  'Pol√≠tica':'var(--l-politica)'
};

/* ===== Dataset ===== */
/* B√ÅSICO (tarjetas ya coloreadas + huecos gu√≠a) */
const BASIC_COLORED = [
  {id:'b-cat-din', text:'DIN√ÅSTICA', cat:'Din√°stica', hint:'Uni√≥n din√°stica de Isabel I de Castilla y Fernando II de Arag√≥n en 1469. No fusion√≥ instituciones: cada reino mantuvo sus leyes y administraci√≥n (uni√≥n din√°stica).'},
  {id:'b-cat-ter', text:'TERRITORIAL', cat:'Territorial', hint:'Expansi√≥n e integraci√≥n territorial: Granada, control de Canarias, y acuerdos diplom√°ticos como Alca√ßovas.'},
  {id:'b-cat-pol', text:'POL√çTICA', cat:'Pol√≠tica', hint:'Refuerzo del poder real con instituciones como Consejo Real, Chanciller√≠as y Santa Hermandad.'},
  {id:'b-cat-rel', text:'RELIGIOSA', cat:'Religiosa', hint:'Instrumentos de control y reforma religiosa: Inquisici√≥n, expulsiones, patronato regio y regalismo.'},
  {id:'b-cat-lin', text:'LING√ú√çSTICA', cat:'Ling√º√≠stica', hint:'Primera gram√°tica del castellano (Nebrija, 1492): fija reglas y sirve para cohesionar el reino.'},

  // Din√°stica
  {id:'b-d1', text:'Matrimonio (1469) de ambos Trast√°mara', cat:'Din√°stica', hint:'Isabel y Fernando unieron sus coronas por matrimonio; cada reino conserv√≥ fueros y √≥rganos propios (uni√≥n din√°stica, no estatal).'},
  {id:'b-d2', text:'Cada reino conserva administraci√≥n, leyes y pol√≠tica', cat:'Din√°stica', hint:'La monarqu√≠a resultante fue compuesta: no hubo fusi√≥n institucional completa.'},

  // Territorial
  {id:'b-t1', text:'Conquista de Granada (1482‚Äì1492)', cat:'Territorial', hint:'La guerra de Granada integr√≥ el √∫ltimo reino nazar√≠ en Castilla y se considera el cierre de la Reconquista.'},
  {id:'b-t2', text:'1479 Tratado de Alca√ßovas', cat:'Territorial', hint:'Puso fin a la guerra de Sucesi√≥n; Portugal reconoci√≥ a Isabel. Reparto de esferas atl√°nticas.'},
  {id:'b-t3', text:'Maestrazgos ‚Üí Realengo', cat:'Territorial', hint:'Las √ìrdenes Militares (Santiago, Alc√°ntara, Calatrava) pasaron a control directo de la Corona (realengo).'},
  {id:'b-t4', text:'Canarias (B√©thencourt; baja resistencia guanche)', cat:'Territorial', hint:'Proceso de conquista y colonizaci√≥n atl√°ntica; base para la expansi√≥n hacia Am√©rica.'},

  // Religiosa
  {id:'b-r1', text:'1482 Inquisici√≥n (√≥rgano de control social)', cat:'Religiosa', hint:'Tribunal eclesi√°stico bajo tutela real para vigilar ortodoxia y cohesi√≥n. Creada por bula papal, aplicada por la Corona.'},
  {id:'b-r2', text:'1492 Expulsi√≥n de jud√≠os', cat:'Religiosa', hint:'Edicto de Granada: oblig√≥ a elegir entre conversi√≥n o salida de los reinos.'},
  {id:'b-r3', text:'1500 Expulsi√≥n/Conversi√≥n de musulmanes (moriscos)', cat:'Religiosa', hint:'Proceso de conversiones forzadas y posterior control de los moriscos; impulsos reformistas de Cisneros.'},
  {id:'b-r4', text:'Patronato regio', cat:'Religiosa', hint:'Privilegios concedidos por el papado a los reyes para intervenir en asuntos eclesi√°sticos (derecho de presentaci√≥n y gesti√≥n de beneficios).'},
  {id:'b-r5', text:'Reforma de la Iglesia (conventos, formaci√≥n del clero)', cat:'Religiosa', hint:'Programa de reforma disciplinaria y educativa del clero impulsado desde la Corona.'},
  {id:'b-r6', text:'Regalismo', cat:'Religiosa', hint:'Pol√≠tica que refuerza la superioridad del poder real frente a Roma en asuntos de la Iglesia.'},

  // Ling√º√≠stica
  {id:'b-l1', text:'1¬™ gram√°tica del castellano (1492): Nebrija', cat:'Ling√º√≠stica', hint:'Primera gram√°tica impresa de una lengua romance; ‚Äúcompa√±era del imperio‚Äù: herramienta de unificaci√≥n y administraci√≥n.'}
];

/* PRO (sin color hasta acertar) */
const PRO_ITEMS = [
  {id:'p-d1',text:'Matrimonio (1469) de ambos Trast√°mara', cat:'Din√°stica', hint:'Isabel de Castilla y Fernando de Arag√≥n unieron dinast√≠as, no instituciones (cada reino conserv√≥ sus leyes).'},
  {id:'p-d2',text:'Cada reino conserva: administraci√≥n, leyes y pol√≠tica', cat:'Din√°stica', hint:'Monarqu√≠a compuesta: coordinaci√≥n real sobre reinos jur√≠dicamente distintos.'},

  {id:'p-t1',text:'Conquista de Granada (1482‚Äì1492)', cat:'Territorial', hint:'Integraci√≥n del reino nazar√≠ en Castilla y fin de la Reconquista.'},
  {id:'p-t2',text:'1479 Tratado de Alca√ßovas (Portugal reconoce a Isabel)', cat:'Territorial', hint:'Fin de la guerra de Sucesi√≥n; reparto del Atl√°ntico y paz con Portugal.'},
  {id:'p-t3',text:'Canarias (s. XV, B√©thencourt; poca resistencia guanche)', cat:'Territorial', hint:'Conquista y colonizaci√≥n atl√°ntica; plataforma para rutas oce√°nicas.'},
  {id:'p-t4',text:'Maestrazgos ‚Üí Realengo', cat:'Territorial', hint:'Incorporaci√≥n de las √ìrdenes Militares al patrimonio de la Corona.'},

  {id:'p-r1',text:'1482 Inquisici√≥n (control social)', cat:'Religiosa', hint:'Tribunal para vigilar la ortodoxia con fuerte tutela de la Corona.'},
  {id:'p-r2',text:'1492 Expulsi√≥n de jud√≠os', cat:'Religiosa', hint:'Conversi√≥n o exilio: Edicto de Granada.'},
  {id:'p-r3',text:'1500 Expulsi√≥n/Conversi√≥n de musulmanes', cat:'Religiosa', hint:'Conversi√≥n forzada y vigilancia posterior de los moriscos.'},
  {id:'p-r4',text:'Patronato regio', cat:'Religiosa', hint:'Privilegios para presentar candidatos y gestionar beneficios eclesi√°sticos.'},
  {id:'p-r5',text:'Reforma de la Iglesia (conventos, formaci√≥n del clero)', cat:'Religiosa', hint:'Fortalecer disciplina y formaci√≥n del clero.'},
  {id:'p-r6',text:'Regalismo', cat:'Religiosa', hint:'Preeminencia del poder real frente al papado en materias eclesi√°sticas.'},

  {id:'p-l1',text:'1¬™ gram√°tica del castellano (1492): Nebrija', cat:'Ling√º√≠stica', hint:'Primera gram√°tica impresa de una lengua romance; fija reglas del castellano.'},

  {id:'p-p1',text:'Autoridad real sobre la nobleza', cat:'Pol√≠tica', hint:'La Corona limita el poder de grandes linajes y centraliza decisiones.'},
  {id:'p-p2',text:'Reformas institucionales', cat:'Pol√≠tica', hint:'Racionalizaci√≥n del gobierno y justicia bajo √≥rganos permanentes.'},
  {id:'p-p3',text:'La Santa Hermandad (orden en caminos)', cat:'Pol√≠tica', hint:'Milicia concejil financiada con impuestos locales; antecedente policial organizado.'},
  {id:'p-p4',text:'Consejo Real (cl√©rigos y juristas)', cat:'Pol√≠tica', hint:'√ìrgano de gobierno y consulta de mayor rango en Castilla.'},
  {id:'p-p5',text:'Chanciller√≠as (tribunales profesionales)', cat:'Pol√≠tica', hint:'M√°ximas instancias judiciales territoriales (Valladolid y Granada).'},
  {id:'p-p6',text:'Ej√©rcito permanente (nobles)', cat:'Pol√≠tica', hint:'Paso hacia fuerzas regulares bajo mando real.'},
  {id:'p-p7',text:'Hacienda Real (recauda impuestos)', cat:'Pol√≠tica', hint:'Ingresos estables: menor dependencia de Cortes.'},
  {id:'p-p8',text:'Cortes pierden peso (menos subsidios)', cat:'Pol√≠tica', hint:'Con una Hacienda fortalecida, el rey convoca menos para pedir servicios.'},
  {id:'p-p9',text:'Fernando asume √ìrdenes Militares', cat:'Pol√≠tica', hint:'Controla Santiago, Alc√°ntara y Calatrava para reforzar poder y recursos.'}
];

/* ===== Estado / utilidades ===== */
const LS_KEY='rrcc-puzzle-visual-v5';
const state={mode:'basic', started:false, startAt:0, best: JSON.parse(localStorage.getItem(LS_KEY)||'{}')};
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const pad=n=>String(n).padStart(2,'0');
const fmt=s=>`${pad(Math.floor(s/60))}:${pad(Math.floor(s%60))}`;
const shuffle=a=>a.sort(()=>Math.random()-.5);
let tick=null;
function startTimer(){ if(state.started) return; state.started=true; state.startAt=Date.now(); tick=setInterval(()=>{$('#timer').textContent=fmt(Math.floor((Date.now()-state.startAt)/1000))},250); }
function stopTimer(){ if(!state.started) return 0; clearInterval(tick); const secs=Math.floor((Date.now()-state.startAt)/1000); state.started=false; return secs; }
function updateBest(){ const k=state.mode==='basic'?'basicBest':'proBest'; const b=state.best[k]; $('#best').textContent=b?`Mejor (${state.mode}): ${fmt(b)}`:''; }
function flash(n,k){ n.classList.add(k); setTimeout(()=>n.classList.remove(k),500); }

/* ===== DOM ===== */
const deckSection = $('#deckSection');
const deck = $('#deck');
const leftCount = $('#leftCount');
const basicBoard = $('#basicBoard');
const basicCols = $('#basicCols');
const proBoard = $('#proBoard');
const proCols = $('#proCols');

/* ===== Helpers DnD ===== */
function makeCard(obj,{forceColor=null}={}){
  const card=document.createElement('div');
  card.className='card rounded-xl border shadow-sm p-3 text-[15px] bg-white';
  card.setAttribute('draggable','true');
  card.dataset.id=obj.id; card.dataset.cat=obj.cat; card.dataset.hint=obj.hint||'';
  card.innerHTML=`<div class="flex items-center justify-between gap-2">
    <span class="leading-5">${obj.text}</span>
    <span class="text-[11px] px-2 py-[2px] rounded-full bg-black/5">√≠tem</span>
  </div>`;
  if(forceColor){
    card.style.background=forceColor.bg;
    card.style.color=forceColor.fg||'white';
    card.style.borderColor='transparent';
  }
  card.addEventListener('dragstart', ev=>{
    ev.dataTransfer.setData('text/plain', JSON.stringify({id:obj.id,cat:obj.cat}));
    ev.dataTransfer.effectAllowed='move';
    card.dataset.origin = card.parentElement.id || card.parentElement.dataset.slotId || 'deck';
    startTimer();
  });
  card.addEventListener('click', ()=>{
    if(!hintMode) return;
    showHint(card, card.dataset.hint || 'Sin pista.');
    hintMode=false; $('#hintBtn').classList.remove('ring-4','ring-amber-300/70');
  });
  return card;
}

function bindZone(zone, validator, options={}){
  zone.addEventListener('dragover', ev=>{ev.preventDefault(); zone.classList.add('drag-over'); ev.dataTransfer.dropEffect='move';});
  zone.addEventListener('dragleave', ()=>zone.classList.remove('drag-over'));
  zone.addEventListener('drop', ev=>{
    ev.preventDefault(); zone.classList.remove('drag-over');
    const data=JSON.parse(ev.dataTransfer.getData('text/plain')||'{}');
    const card=document.querySelector(`[data-id="${data.id}"]`);
    if(!card) return;
    if(!validator(data)){ returnToOrigin(card); return; }
    if(options.isDeck){ deck.appendChild(card); paint(card,null); updateLeft(); return; }
    if(options.autoIntoSlot){
      const free=$$('.slot', zone).find(s=>!s.querySelector('.card'));
      if(free){ placeInSlot(card, free); } else { returnToOrigin(card); }
    }else{ zone.appendChild(card); paint(card,data.cat); }
    updateLeft(); checkWin();
  });
}

function bindSlot(slot, validator){
  slot.addEventListener('dragover', ev=>{ev.preventDefault(); slot.classList.add('drag-over'); ev.dataTransfer.dropEffect='move';});
  slot.addEventListener('dragleave', ()=>slot.classList.remove('drag-over'));
  slot.addEventListener('drop', ev=>{
    ev.preventDefault(); slot.classList.remove('drag-over');
    const data=JSON.parse(ev.dataTransfer.getData('text/plain')||'{}');
    const card=document.querySelector(`[data-id="${data.id}"]`);
    if(!card) return;
    if(!validator(data) || slot.querySelector('.card')){ returnToOrigin(card); return; }
    placeInSlot(card, slot); updateLeft(); checkWin();
  });
}

function placeInSlot(card, slot){ slot.appendChild(card); slot.classList.add('filled'); paint(card, card.dataset.cat); }
function returnToOrigin(card){
  const origin=card.dataset.origin;
  if(origin && origin.startsWith('slot-')){
    const el=document.querySelector(`[data-slot-id="${origin}"]`);
    if(el) el.appendChild(card); else deck.appendChild(card);
  }else if(origin && origin!=='deck'){
    const container=document.getElementById(origin);
    if(container) container.appendChild(card); else deck.appendChild(card);
  }else{ deck.appendChild(card); }
  paint(card,null); flash(card,'bg-red-100');
}
function paint(card, cat){
  if(!cat){ card.style.background='white'; card.style.color='#0f172a'; card.style.borderColor='#CBD5E1'; return; }
  const light=LIGHTS[cat]||'white'; card.style.background=light; card.style.color='#0f172a'; card.style.borderColor='transparent'; flash(card,'bg-green-100');
}
function updateLeft(){ leftCount.textContent = deck.children.length ? `${deck.children.length} por colocar` : '¬°Todas colocadas!'; }
function groupBy(arr,f){return arr.reduce((m,x)=>{const k=f(x); (m[k]=m[k]||[]).push(x); return m;},{});}

/* ===== Render ===== */
function clearAll(){
  deck.innerHTML=''; leftCount.textContent='';
  proCols.innerHTML=''; basicCols.innerHTML='';
  $('#timer').textContent='00:00'; stopTimer(); updateBest();
}

function renderBasic(){
  clearAll();
  basicBoard.classList.remove('hidden'); proBoard.classList.add('hidden');

  // Construir columnas con HUECOS GU√çA coloreados (tantos como items de esa unidad)
  const groups = groupBy(BASIC_COLORED, x=>x.cat);
  const order = ['Din√°stica','Territorial','Pol√≠tica','Religiosa','Ling√º√≠stica'];
  order.forEach(cat=>{
    const col=document.createElement('div');
    col.className='flex flex-col';
    col.innerHTML=`
      <div class="rounded-xl px-3 py-2 text-sm font-semibold text-white" style="background:${COLORS[cat]}">${cat.toUpperCase()}</div>
      <div class="dropzone rounded-xl p-3 bg-slate-50 border mt-2" data-accept="${cat}">
        <div class="grid gap-2" style="grid-template-columns:1fr;"></div>
      </div>`;
    basicCols.appendChild(col);
    const grid=$('.grid', col);
    const n=(groups[cat]||[]).length;
    for(let i=0;i<n;i++){
      const slot=document.createElement('div');
      slot.className='slot';
      slot.dataset.accept=cat; slot.dataset.slotId=`slotB-${cat}-${i}`;
      slot.style.background = LIGHTS[cat];   /* hueco gu√≠a coloreado */
      slot.style.borderColor = COLORS[cat];
      grid.appendChild(slot);
      bindSlot(slot, payload=>payload.cat===cat);
    }
    // permitir soltar sobre la caja para auto-encajar en el primer hueco libre
    bindZone($('.dropzone', col), payload=>payload.cat===cat, {autoIntoSlot:true});
  });

  // Tarjetas COLOREADAS desde el inicio
  shuffle([...BASIC_COLORED]).forEach(o=>{
    deck.appendChild(makeCard(o,{forceColor:{bg:COLORS[o.cat], fg:'white'}}));
  });
  updateLeft();

  bindZone(deck, ()=>true, {isDeck:true});
  deckSection.classList.add('deck-dock');
  deckSection.classList.remove('deck-sidebar');
}

function renderPro(){
  clearAll();
  basicBoard.classList.add('hidden'); proBoard.classList.remove('hidden');

  // Columnas con slots coloreados por unidad
  const groups=groupBy(PRO_ITEMS, x=>x.cat);
  const order=['Din√°stica','Territorial','Pol√≠tica','Religiosa','Ling√º√≠stica'];
  order.forEach(cat=>{
    const col=document.createElement('div');
    col.className='flex flex-col';
    col.innerHTML=`
      <div class="rounded-xl px-3 py-2 text-sm font-semibold text-white" style="background:${COLORS[cat]}">${cat.toUpperCase()}</div>
      <div class="dropzone rounded-xl p-3 bg-slate-50 border mt-2" data-accept="${cat}">
        <div class="grid gap-2" style="grid-template-columns:1fr;"></div>
      </div>`;
    proCols.appendChild(col);
    const grid=$('.grid', col);
    const n=(groups[cat]||[]).length;
    for(let i=0;i<n;i++){
      const slot=document.createElement('div');
      slot.className='slot';
      slot.dataset.accept=cat; slot.dataset.slotId=`slot-${cat}-${i}`;
      slot.style.background = LIGHTS[cat];   /* hueco del color de su unidad */
      slot.style.borderColor = COLORS[cat];
      grid.appendChild(slot);
      bindSlot(slot, payload=>payload.cat===cat);
    }
    bindZone($('.dropzone', col), payload=>payload.cat===cat, {autoIntoSlot:true});
  });

  // Tarjetas SIN color hasta acertar
  shuffle([...PRO_ITEMS]).forEach(o=>deck.appendChild(makeCard(o)));
  updateLeft();

  bindZone(deck, ()=>true, {isDeck:true});
  deckSection.classList.remove('deck-dock');
  deckSection.classList.add('deck-sidebar');
}

/* ===== Victoria / Comod√≠n ===== */
function checkWin(){
  if(state.mode==='basic'){
    // Todos los huecos ocupados
    const slots = $$('#basicBoard .slot');
    if(slots.length && slots.every(s=>s.querySelector('.card'))){ onWin(); }
  }else{
    const slots=$$('#proBoard .slot');
    if(slots.length && slots.every(s=>s.querySelector('.card'))){ onWin(); }
  }
}
function onWin(){
  const secs=stopTimer();
  const key=state.mode==='basic'?'basicBest':'proBest';
  if(!state.best[key] || secs<state.best[key]){ state.best[key]=secs; localStorage.setItem(LS_KEY, JSON.stringify(state.best)); }
  updateBest();
  $('#resultTxt').innerHTML=`Tiempo: <b>${fmt(secs)}</b><br>Mejor (${state.mode}): <b>${fmt(state.best[key])}</b>`;
  $('#winDlg').showModal();
}
let hintMode=false;
function showHint(target, text){
  $$('.hint-bubble').forEach(n=>n.remove());
  const b=document.createElement('div'); b.className='hint-bubble'; b.textContent=text;
  document.body.appendChild(b);
  const r=target.getBoundingClientRect();
  const top=window.scrollY + r.top - b.offsetHeight - 8;
  const left=window.scrollX + r.left + r.width/2 - Math.min(b.offsetWidth,280)/2;
  b.style.top=`${Math.max(8,top)}px`; b.style.left=`${Math.max(8,left)}px`;
  setTimeout(()=>b.remove(),5000);
}

/* ===== Eventos ===== */
$('#basicBtn').addEventListener('click', ()=>{state.mode='basic'; renderBasic();});
$('#proBtn').addEventListener('click', ()=>{state.mode='pro'; renderPro();});
$('#resetBtn').addEventListener('click', ()=>{state.started=false; (state.mode==='basic'?renderBasic:renderPro)();});
$('#hintBtn').addEventListener('click', ()=>{ hintMode=!hintMode; $('#hintBtn').classList.toggle('ring-4'); $('#hintBtn').classList.toggle('ring-amber-300/70'); });
$('#againBtn').addEventListener('click', ()=>{ $('#winDlg').close(); state.started=false; (state.mode==='basic'?renderBasic:renderPro)();});
$('#closeBtn').addEventListener('click', ()=>$('#winDlg').close());
bindZone(deck, ()=>true, {isDeck:true});

/* ===== Inicio: B√°sico con huecos gu√≠a ===== */
(function init(){ state.mode='basic'; renderBasic(); })();
</script>
</body>
</html>
